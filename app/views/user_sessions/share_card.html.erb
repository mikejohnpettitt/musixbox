
<head>
  <title>Share Card - MusixBox</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <%= stylesheet_link_tag "application", "data-turbo-track": "reload" %>
  <!-- Biblioth√®que pour capturer la card en image -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    /* Pour impression/screenshot propre */
    @media print {
      .no-print { display: none !important; }
    }
  </style>
</head>
<body class="bg-gradient min-vh-100">

  <!-- NAVBAR -->
  <%= render "shared/navbar" %>

  <div class="container d-flex align-items-center" style="min-height: calc(100vh - 80px);">
    <div class="row justify-content-center w-100">
      <div class="col-12 col-md-8 col-lg-6">

        <%= render "shared/card" %>

        <!-- BOUTONS PARTAGE ET SAUVEGARDE -->
        <div class="d-flex gap-2 mt-4 justify-content-center no-print">
          <button onclick="savePhoto()" class="btn btn-warning btn-lg w-100">
            üíæ Sauvegarder
          </button>
          <button onclick="shareResults()" class="btn btn-success btn-lg w-100">
            üì§ Partager
          </button>
        </div>

      </div> 

    </div>
  </div>

  <script>
    // ============================================
    // FONCTION 1 : Partager les r√©sultats
    // ============================================
    function shareResults() {
      if (navigator.share) {
        navigator.share({
          title: 'Mes r√©sultats MusixBox',
          text: 'J\'ai termin√© ma session sur MusixBox ! üéµ',
          url: window.location.href
        });
      } else {
        navigator.clipboard.writeText(window.location.href)
          .then(() => alert('Lien copi√© ! Collez-le pour partager.'));
      }
    }
    
    // ============================================
    // FONCTION 2 : Sauvegarder la card compl√®te
    // ============================================
    // Cette fonction capture la card (photo + textes) en une seule image
    function savePhoto() {
      // On r√©cup√®re l'√©l√©ment card-result (la card avec photo + textes)
      const cardElement = document.querySelector(".card-result")
      
      if (!cardElement) {
        alert("Pas de card √† sauvegarder")
        return
      }
      
      // html2canvas capture l'√©l√©ment HTML comme une image
      // C'est comme faire une capture d'√©cran d'un √©l√©ment pr√©cis
      html2canvas(cardElement, {
        useCORS: true,           // Pour les images externes
        allowTaint: true,        // Permet les images locales
        backgroundColor: null,   // Fond transparent
        scale: 2                 // Qualit√© x2 pour une meilleure r√©solution
      }).then(function(canvas) {
        // On convertit le canvas en image PNG
        const imageData = canvas.toDataURL("image/png")
        
        // On cr√©e un lien invisible pour t√©l√©charger
        const link = document.createElement("a")
        link.href = imageData
        link.download = `musixbox_${Date.now()}.png`
        
        // On simule un clic pour t√©l√©charger
        document.body.appendChild(link)
        link.click()
        document.body.removeChild(link)
        
      }).catch(function(error) {
        console.error("Erreur de capture:", error)
        alert("Erreur lors de la sauvegarde")
      })
    }
  </script>

</body>
